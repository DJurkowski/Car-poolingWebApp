CREATE BOOTSAMPLE  IDENTIFIED BY "BOOTSAMPLE"  ;

#PRIVILEGES

grant connect to BOOTSAMPLE;
GRANT RESOURCE, DBA TO BOOTSAMPLE;
GRANT CREATE SESSION TO BOOTSAMPLE;
GRANT UNLIMITED TABLESPACE TO BOOTSAMPLE;


insert into T_TASKS values(2,'task2','desc1',SYSDATE + 1,0)

CREATE SEQUENCE NUM_SEQ START WITH 4;
commit

CREATE TABLE UZYTKOWNIK
   (	"IDUZYTKOWNIKA" NUMBER(5,0),
	"IMIE" VARCHAR2(25 BYTE),
	"NAZWISKO" VARCHAR2(50 BYTE),
	"MAIL" VARCHAR2(50 BYTE),
	"PLEC" VARCHAR2(10 BYTE),
	"ROKURODZENIA" NUMBER(5,0),
	"TELEFON" VARCHAR2(15 BYTE)
   );

   ALTER TABLE UZYTKOWNIK ADD(
        CONSTRAINT USER_PK PRIMARY KEY(IDUZYTKOWNIKA)
);

CREATE SEQUENCE USER_SEQ START WITH 1;

create table KONTO
(	"IDUZYTKOWNIKA" NUMBER(5,0),
	"LOGIN" VARCHAR2(25 BYTE),
    "HASLO" VARCHAR2(50 BYTE)
);

   ALTER TABLE KONTO ADD(
        CONSTRAINT KONTO_PK PRIMARY KEY(IDUZYTKOWNIKA)
);

ALTER TABLE "KONTO" ADD CONSTRAINT "KONTO_IDUZYTKOWNIKA" FOREIGN KEY ("IDUZYTKOWNIKA")
REFERENCES "UZYTKOWNIK" ("IDUZYTKOWNIKA") ENABLE;

commit

CREATE SEQUENCE ACCOUNT_SEQ START WITH 1;
commit
ALTER TABLE "KONTO" DROP CONSTRAINT KONTO_IDUZYTKOWNIKA;

ALTER TABLE "KONTO" ADD CONSTRAINT KONTO_UZYTKOWNIKA FOREIGN KEY (IDUZYTKOWNIKA) REFERENCES UZYTKOWNIK(IDUZYTKOWNIKA);
commit
ALTER TABLE "KONTO" DROP CONSTRAINT KONTO_UZYTKOWNIKA;

--dodanie jeszcze jeden zmiennej jako klucz obcy bo sypalo blad jak bylo klczuem obcym klucz glowny jednoczesnie
alter table konto add IDUZYTKOWNIKA_KONTO NUMBER(5,0)
ALTER TABLE "KONTO" ADD CONSTRAINT KONTO_UZYTKOWNIKA FOREIGN KEY (IDUZYTKOWNIKA_KONTO) REFERENCES UZYTKOWNIK(IDUZYTKOWNIKA);

--oferta przejazdu
CREATE TABLE "OFERTAPRZEJAZDU"
   (	"IDPRZEJAZDU" NUMBER(5,0),
	"DATA" DATE,
	"KOSZT" NUMBER(5,0),
	"WOLNEMIEJSCA" NUMBER(1,0),
	"IDPREFERENCJI" NUMBER(5,0),
	"IDKIEROWCY" NUMBER(5,0),
	"IDTRASY_OFERTA" NUMBER(5,0)
   );

ALTER TABLE OFERTAPRZEJAZDU ADD(
CONSTRAINT OFERTAPRZEJAZDU_PK PRIMARY KEY(IDPRZEJAZDU)
);

CREATE SEQUENCE OFERTAPRZEJAZDU_SEQ START WITH 1;

--trasa
 CREATE TABLE "TRASA"
   (	"IDTRASY" NUMBER(5,0),
	"PANSTWOPOCZATKOWE" VARCHAR2(50 BYTE),
	"MIASTOPOCZATKOWE" VARCHAR2(50 BYTE),
	"PANSTWODOCELOWE" VARCHAR2(50 BYTE),
	"MIASTODOCELOWE" VARCHAR2(50 BYTE)
   );

CREATE SEQUENCE TRASA_SEQ START WITH 1;

ALTER TABLE TRASA ADD(
CONSTRAINT TRASA_PK PRIMARY KEY(IDTRASY)
);

-- preferencje
CREATE TABLE "PREFERENCJE"
   (	"IDPREFERENCJI" NUMBER(5,0),
	"CZYNIEPALACY" VARCHAR2(20 BYTE),
	"PREFEROWANAPLEC" VARCHAR2(25 BYTE),
	"CZYZWIERZAK" VARCHAR2(50 BYTE)
   );

CREATE SEQUENCE PREFERENCJE_SEQ START WITH 1;

ALTER TABLE PREFERENCJE ADD(
CONSTRAINT PREFERENCJE_PK PRIMARY KEY(IDPREFERENCJI)
);

--adres
CREATE TABLE "ADRES"
   (	"IDMIEJSCA" NUMBER(5,0),
	"PANSTWO" VARCHAR2(50 BYTE),
	"MIASTO" VARCHAR2(50 BYTE)
   );

ALTER TABLE ADRES ADD(
CONSTRAINT ADRES_PK PRIMARY KEY(IDMIEJSCA)
);

CREATE SEQUENCE ADRES_SEQ START WITH 1;

--kierowca
CREATE TABLE "KIEROWCA"
   (	"IDKIEROWCY" NUMBER(5,0),
	"IDUZYTKOWNIKA" NUMBER(5,0),
	"IDSAMOCHODU" NUMBER(5,0)
   );

ALTER TABLE KIEROWCA ADD(
  CONSTRAINT KIEROWCA_PK PRIMARY KEY(IDKIEROWCY)
  );

CREATE SEQUENCE KIEROWCA_SEQ START WITH 1;

--opinia
CREATE TABLE "OPINIA"
   (	"IDOPINII" NUMBER(5,0),
	"KOMENTARZ" VARCHAR2(255 BYTE),
	"OCENA" NUMBER(5,0),
	"IDUZYTKOWNIKA" NUMBER(5,0)
   );

    ALTER TABLE OPINIA ADD(
      CONSTRAINT OPINIA_PK PRIMARY KEY(IDOPINII)
      );

CREATE SEQUENCE OPINIA_SEQ START WITH 1;

--rezerwacjaprzejazdu
CREATE TABLE "REZERWACJAPRZEJAZDU"
   (	"IDDOLACZENIA" NUMBER(5,0),
	"DATA" DATE,
	"IDPRZEJAZDU" NUMBER(5,0)
   );

  ALTER TABLE REZERWACJAPRZEJAZDU ADD(
 CONSTRAINT REZERWACJAPRZEJAZDU_PK PRIMARY KEY(IDDOLACZENIA)
 );
 CREATE SEQUENCE REZERWACJAPRZEJAZDU_SEQ START WITH 1;

--rezerwacjaprzejazduUzytkownika

     CREATE TABLE "REZERWACJAPRZEJAZDUUZYTKOWNIK"
   (	"IDUZYTKOWNIKA" NUMBER(5,0),
	"IDDOLACZENIA" NUMBER(5,0)
   );

     ALTER TABLE REZERWACJAPRZEJAZDUUZYTKOWNIK ADD(
    CONSTRAINT REZERWACJAPRZEJAZDUZ_PK PRIMARY KEY(IDUZYTKOWNIKA)
    );
  CREATE SEQUENCE REZERWACJAPRZEJAZDUZ_SEQ START WITH 1;

--samochod
CREATE TABLE "SAMOCHOD"
   (	"IDSAMOCHODU" NUMBER(5,0),
	"MARKA" VARCHAR2(50 BYTE),
	"MODEL" VARCHAR2(50 BYTE),
	"NRREJESTRACYJNY" VARCHAR2(10 BYTE),
	"LICZBAMIEJSC" NUMBER(1,0)
   );
  ALTER TABLE SAMOCHOD ADD(
 CONSTRAINT SAMOCHOD_PK PRIMARY KEY(IDSAMOCHODU)
 );

  CREATE SEQUENCE SAMOCHOD_SEQ START WITH 1;

--kierowca constraint
 ALTER TABLE "KIEROWCA" ADD CONSTRAINT "KIEROWCA_IDSAMOCHODU" FOREIGN KEY ("IDSAMOCHODU")
	  REFERENCES "SAMOCHOD" ("IDSAMOCHODU") ENABLE;

  ALTER TABLE "KIEROWCA" ADD CONSTRAINT "KIEROWCA_IDUZYTKOWNIKA" FOREIGN KEY ("IDUZYTKOWNIKA")
	  REFERENCES "UZYTKOWNIK" ("IDUZYTKOWNIKA") ENABLE;

--oferta przejazdu constraint
 ALTER TABLE "OFERTAPRZEJAZDU" ADD CONSTRAINT "OFERTAPRZEJAZDU_IDKIEROWCY" FOREIGN KEY ("IDKIEROWCY")
	  REFERENCES "KIEROWCA" ("IDKIEROWCY") ENABLE;

  ALTER TABLE "OFERTAPRZEJAZDU" ADD CONSTRAINT "OFERTAPRZEJAZDU_IDPREFERENCJI" FOREIGN KEY ("IDPREFERENCJI")
	  REFERENCES "PREFERENCJE" ("IDPREFERENCJI") ENABLE;

  ALTER TABLE "OFERTAPRZEJAZDU" ADD CONSTRAINT "OFERTAPRZEJAZDU_IDTRASY" FOREIGN KEY ("IDTRASY_OFERTA")
	  REFERENCES "TRASA" ("IDTRASY") ENABLE;

--opinia constraint
 ALTER TABLE "OPINIA" ADD CONSTRAINT "OPINIE_IDUZYTKOWNIKA" FOREIGN KEY ("IDUZYTKOWNIKA")
	  REFERENCES "UZYTKOWNIK" ("IDUZYTKOWNIKA") ENABLE;

-- rezerwacja przejazdu constraint
ALTER TABLE "REZERWACJAPRZEJAZDU" ADD CONSTRAINT "REZERWACJA_IDPRZEJAZDU" FOREIGN KEY ("IDPRZEJAZDU")
	  REFERENCES "OFERTAPRZEJAZDU" ("IDPRZEJAZDU") ENABLE;

--rezerwacjaprzejazduUzytkownik constraint
ALTER TABLE "REZERWACJAPRZEJAZDUUZYTKOWNIK" ADD CONSTRAINT "REZUZYTKOWNIK_IDDOLACZENIA" FOREIGN KEY ("IDDOLACZENIA")
	  REFERENCES "REZERWACJAPRZEJAZDU" ("IDDOLACZENIA") ENABLE;

  ALTER TABLE "REZERWACJAPRZEJAZDUUZYTKOWNIK" ADD CONSTRAINT "REZUZYTKOWNIK_IDUZYTKOWNIKA" FOREIGN KEY ("IDUZYTKOWNIKA")
	  REFERENCES "UZYTKOWNIK" ("IDUZYTKOWNIKA") ENABLE;

--usuniecie klucza glownego
ALTER TABLE REZERWACJAPRZEJAZDUUZYTKOWNIK DROP CONSTRAINT REZERWACJAPRZEJAZDUZ_PK;

--OFERTAPRZEJAZDU zmiana date na varchar
alter table ofertaprzejazdu modify( data varchar2(50));

--REZERWACJAPRZEJAZDY zmiana date na varchar
alter table REZERWACJAPRZEJAZDU modify( data varchar2(50));

--REZERWACJAPRZEJAZDUUZYTKOWNIK
alter table REZERWACJAPRZEJAZDUUZYTKOWNIK add id NUMBER(5, 0);
    --CREATE SEQUENCE REZERWACJAPRZEJAZDUZ_SEQ START WITH 1;
ALTER TABLE REZERWACJAPRZEJAZDUUZYTKOWNIK ADD(
    CONSTRAINT REZERWACJAPRZEJAZDUZ_PK PRIMARY KEY(ID)
    );
commit
--Usuniecie tabeli REZERWACJAPRZEJAZDUUZYTKOWNIK
DROP TABLE REZERWACJAPRZEJAZDUUZYTKOWNIK;

--dodanie IDUZYTKOWNIKA do tabeli REZERWACJAPRZEJAZDU
ALTER TABLE REZERWACJAPRZEJAZDU ADD IDUZYTKOWNIKA NUMBER(5,0);
ALTER TABLE "REZERWACJAPRZEJAZDU" ADD CONSTRAINT "REZUZYTKOWNIK_IDUZYTKOWNIKA" FOREIGN KEY ("IDUZYTKOWNIKA")
	  REFERENCES "UZYTKOWNIK" ("IDUZYTKOWNIKA") ENABLE;

-- usuniecie values from table
delete from UZYTKOWNIK where IMIE='Domo';

--Uzupelnianie tabeli UZYTKOWNIK
ALTER TABLE "UZYTKOWNIK" MODIFY ("MAIL" NOT NULL ENABLE);
 ALTER TABLE "UZYTKOWNIK" ADD UNIQUE ("MAIL");

--View UZYTKOWNIKA
CREATE OR REPLACE FORCE VIEW "KONTO_UZYTKOWNIK" ("IDUZYTKOWNIKA", "IMIE", "NAZWISKO", "LOGIN", "HASLO", "MAIL", "PLEC", "ROKURODZENIA", "TELEFON") AS
  select u.IDUZYTKOWNIKA, u.IMIE,u.NAZWISKO, k.LOGIN,k.HASLO, u.MAIL,u.PLEC,u.ROKURODZENIA,u.TELEFON
 from UZYTKOWNIK u left join KONTO k on u.IDUZYTKOWNIKA = k.IDUZYTKOWNIKA_KONTO;

 select * from konto_uzytkownik;

--View PRZEJAZDY
 CREATE OR REPLACE FORCE VIEW "MOJE_PRZEJAZDY" ("IDUZYTKOWNIKA", "IDPRZEJAZDU", "DATA", "KOSZT", "WOLNEMIEJSCA", "CZYNIEPALACY", "CZYZWIERZAK", "PREFEROWANAPLEC") AS
  select u.IDUZYTKOWNIKA,
o.IDPRZEJAZDU IDPRZEJAZDU,
o.DATA DATA,
o.KOSZT KOSZT,
o.WOLNEMIEJSCA WOLNEMIEJSCA,
p.CZYNIEPALACY,
p.CZYZWIERZAK,
p.PREFEROWANAPLEC
from uzytkownik u left join kierowca k on u.IDUZYTKOWNIKA=k.IDUZYTKOWNIKA  join ofertaprzejazdu o on k.IDKIEROWCY=o.IDKIEROWCY join preferencje p on o.idpreferencji = p.idpreferencji;

select * from moje_przejazdy;

--usuniecie
delete from KIEROWCA where IDUZYTKOWNIKA = 61

--procedura USUN_KONTO
set define off;

  CREATE OR REPLACE PROCEDURE "USUN_KONTO" (id number)
is
begin
    delete from kierowca where iduzytkownika=id;
    delete from konto where iduzytkownika=id;
    delete from uzytkownik where iduzytkownika = id;
end;

--procedure wykonanie
begin
    USUN_KONTO(9);
end;

--usuwanie procedury
DROP PROCEDURE USUN_KONTO;

--procedura dodaj uzytkownika

set define off;

create or replace PROCEDURE "DODAJ_UZYTKOWNIKA" (LOGIN1 varchar2, HASLO varchar2, IMIE varchar2,
NAZWISKO varchar2, MAIL1 varchar2, PLEC varchar2, ROKURODZENIA number,TELEFON varchar2, czy_login out number)
is
begin
  select count(*) into czy_login from UZYTKOWNIK u where u.MAIL = MAIL;
  if(czy_login=0) then
    insert into uzytkownik values(USER_SEQ.nextval,IMIE,NAZWISKO,MAIL1,PLEC,ROKURODZENIA,TELEFON);
    insert into konto values(ACCOUNT_SEQ.nextval,LOGIN1,HASLO,USER_SEQ.currval);
  end if;

end;

--procedura usun
DROP PROCEDURE DODAJ_UZYTKOWNIKA;

--procedura DODAJ_UZYTKOWNIKA
declare
liczba number;
begin
    DODAJ_UZYTKOWNIKA('JANUSZ','123','JANUSZ','TOKARZ','JANUSZ@GMAIL.COM','MAN',1980,'123258963',liczba);
    dbms_output.put_line(liczba);
end;